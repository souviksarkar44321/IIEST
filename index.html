<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMSL - System Information</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h2 { text-align: center; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    th, td { border: 1px solid #333; padding: 8px; text-align: center; }
    th { background: #e9ecef; }
    input { width: 90%; padding: 5px; }
    button { padding: 5px 10px; cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h2>AMSL - SYSTEM INFORMATION</h2>

  <!-- Input Table -->
  <table id="inputTable">
    <thead>
      <tr>
        <th>System Name</th>
        <th>Total Cores</th>
        <th>Cores in Process</th>
        <th>Available Cores</th>
        <th>User's Name</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Alpha-912</td><td>24</td>
        <td><input type="number" class="process" min="0"></td>
        <td class="available"></td>
        <td><input type="text" class="username"></td>
        <td><input type="date" class="start"></td>
        <td><input type="date" class="end"></td>
        <td><button onclick="saveData(this)">Save</button></td>
      </tr>
      <tr>
        <td>Beta-913</td><td>24</td>
        <td><input type="number" class="process" min="0"></td>
        <td class="available"></td>
        <td><input type="text" class="username"></td>
        <td><input type="date" class="start"></td>
        <td><input type="date" class="end"></td>
        <td><button onclick="saveData(this)">Save</button></td>
      </tr>
      <tr>
        <td>Gamma-16</td><td>16</td>
        <td><input type="number" class="process" min="0"></td>
        <td class="available"></td>
        <td><input type="text" class="username"></td>
        <td><input type="date" class="start"></td>
        <td><input type="date" class="end"></td>
        <td><button onclick="saveData(this)">Save</button></td>
      </tr>
      <tr>
        <td>Delta-96</td><td>96</td>
        <td><input type="number" class="process" min="0"></td>
        <td class="available"></td>
        <td><input type="text" class="username"></td>
        <td><input type="date" class="start"></td>
        <td><input type="date" class="end"></td>
        <td><button onclick="saveData(this)">Save</button></td>
      </tr>
      <tr>
        <td>Lambda-256</td><td>256</td>
        <td><input type="number" class="process" min="0"></td>
        <td class="available"></td>
        <td><input type="text" class="username"></td>
        <td><input type="date" class="start"></td>
        <td><input type="date" class="end"></td>
        <td><button onclick="saveData(this)">Save</button></td>
      </tr>
    </tbody>
  </table>

  <!-- History Table -->
  <h2>History</h2>
<table id="historyTable">
  <thead>
    <tr>
      <th>Serial No</th>
      <th>Username</th>
      <th>Cores in Process</th>
      <th>Start Date</th>
      <th>End Date</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  <script>
  // ðŸ”— Replace with your own Google Apps Script Web App URL
  const API_URL = "https://script.google.com/macros/s/AKfycbydzNKWHSNiZLtJUSArnyzleMQdt6YOvwYF53QVkuCDeAYN796W8_sqaabsqLxaE4S7iw/exec";  

  let serialNo = 1;

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const computeStatus = (endISO) => (new Date() <= new Date(endISO) ? "Running" : "Completed");

  // Live available cores update
  document.querySelectorAll(".process").forEach(input => {
    input.addEventListener("input", function () {
      const row = this.closest("tr");
      const total = parseInt(row.cells[1].innerText, 10);
      const cores = clamp(parseInt(this.value || "0", 10), 0, total);
      this.value = isNaN(cores) ? "" : cores;
      row.querySelector(".available").innerText = isNaN(cores) ? "" : (total - cores);
    });
  });

  function renderHistory(entries) {
  const body = document.querySelector("#historyTable tbody");
  body.innerHTML = "";
  entries.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.serial}</td>
      <td>${e.username}</td>
      <td>${e.cores}</td>
      <td>${e.start}</td>
      <td>${e.end}</td>
      <td>${computeStatus(e.end)}</td>
    `;
    body.appendChild(tr);
  });
}


  function loadLocalData() {
    const saved = JSON.parse(localStorage.getItem("amslHistory")) || [];
    renderHistory(saved);
    serialNo = (saved.reduce((m, e) => Math.max(m, Number(e.serial) || 0), 0)) + 1;
  }

  async function loadServerData() {
    try {
      const r = await fetch(API_URL, { method: "GET", cache: "no-cache" });
      const rows = await r.json();
      const entries = rows.slice(1).map(r => ({   // âš¡ Skip header row
        serial: r[0],
        username: r[1],
        system: r[2],
        cores: r[3],
        start: r[4],
        end: r[5],
      })).sort((a, b) => Number(b.serial) - Number(a.serial));
      renderHistory(entries);
      localStorage.setItem("amslHistory", JSON.stringify(entries));
      serialNo = (entries.reduce((m, e) => Math.max(m, Number(e.serial) || 0), 0)) + 1;
    } catch (err) {
      console.error("GET failed:", err);
      loadLocalData();
    }
  }

  async function saveData(button) {
    const row = button.closest("tr");
    const systemName = row.cells[0].innerText;   // âš¡ Grab system name
    const total = parseInt(row.cells[1].innerText, 10);

    const coresInProcess = clamp(parseInt(row.querySelector(".process").value || "0", 10), 1, total);
    const username = row.querySelector(".username").value.trim();
    const startDate = row.querySelector(".start").value;
    const endDate   = row.querySelector(".end").value;

    if (!username || !startDate || !endDate || !coresInProcess) {
      alert("Please enter User, Cores in Process (>0), Start Date and End Date.");
      return;
    }

    const entry = {
      serial: serialNo,
      username,
      system: systemName,   // âš¡ Now included
      cores: coresInProcess,
      start: startDate,
      end: endDate
    };

    button.disabled = true;
    button.textContent = "Saving...";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      });

      const srv = await res.json();
      if (srv && srv.ok && srv.serial) {
        entry.serial = srv.serial;
        serialNo = srv.serial + 1;
      } else {
        serialNo += 1;
      }
    } catch (e) {
      console.error("POST failed:", e);
      serialNo += 1;
    }

    // âœ… Always add latest on top
    const saved = JSON.parse(localStorage.getItem("amslHistory")) || [];
    saved.unshift(entry);
    localStorage.setItem("amslHistory", JSON.stringify(saved));
    renderHistory(saved);

    // Clear row
    row.querySelector(".process").value = "";
    row.querySelector(".username").value = "";
    row.querySelector(".start").value = "";
    row.querySelector(".end").value = "";
    row.querySelector(".available").innerText = "";

    button.disabled = false;
    button.textContent = "Save";
  }

  // First load shared data
  loadServerData();
</script>
</body>
</html>
